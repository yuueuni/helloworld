## 스레드 (Thread)

### 프로세스 vs 스레드

- 프로세스(Process)
    - 컴퓨터에서 연속적으로 실행되고 있는 컴퓨터 프로그램
        - 프로그램(Program) : 어떤 작업을 위해 실행할 수 있는 파일
    - 메모리에 올라와 실행되고 있는 프로그램의 인스턴스 (독립적인 개체)
    - 운영체제로부터 시스템 자원을 할당받는 작업의 단위로 동적인 개념으로는 실행된 프로그램을 의미함
- 스레드(Thread)
    - 프로세스 내에서 실행되는 여러 흐름의 단위
        - 프로세스의 특정한 수행 경로로 프로세스가 할당받은 자원을 이용하는 실행의 단위
- 프로세스 간 접근
    - 파이프, 파일, 소켓 등을 이용해 프로세스 간 통신하여 다른 프로세스 자원에 접근
- 스레드 간 접근
    - 스레드는 한 프로세스 내 동작되는 여러 실행의 흐름으로 프로세스 내 주소 공간이나 자원을 스레드끼리 공유하며 실행됨

### 멀티 프로세스, 멀티 스레드

- 멀티 프로세스는 여러 프로그램을 키는 것으로 하나의 프로그램 안에서 여러 작업을 해결하는 멀티 스레드로 사용
    - 자원의 효율성 증대
        - 멀티 프로세스로 실행되는 작업을 멀티 스레드로 실행할 경우 프로세스를 생성하여 자원을 할당하는 시스템 콜이 줄어들어 자원을 효율적으로 관리할 수 있음. 프로세스 간의 Context switching 시 단순히 CPU 레지스터 교체 뿐만 아니라 ram과 cpu 사이의 캐시 메모리에 대한 데이터까지 초기화되므로 오버헤드가 큼
        - **Context Switch(컨텍스트 스위치)**
            - 멀티 프로세스 환경에서 CPU가 어떤 하나의 프로세스를 실행하고 있는 상태에서 인터럽트 요청에 의해 다음 우선 순위의 프로세스가 실행되어야 할 때 기존의 프로세스 상태 또는 레지스터 값(Context)을 저장하고 CPU가 다음 프로세스를 수행하도록 새로운 프로세스의 상태 또는 레지스터 값을 교체하는 작업
            - https://jeong-pro.tistory.com/93
        - 스레드는 프로세스 내 메모리 공유하므로 스레드 간 데이터 주고 받기 간단해 시스템 자원 소모가 줄어듬
    - 처리 비용 감소 및 응답 시간 단축
        - 프로세스 간 통신(IPC)보다 스레드 간의 통신 비용이 적으므로 작업들 간 통신 부담이 줄어듬
- 동기화 문제
    - 스레드 간의 자원 공유는 전역 변수(데이터 세그먼트)를 이용하므로 함께 사용시 충돌이 발생할 수 있다

### Thread-safe

- 스레드 안전을 뜻하는 말로, 멀티 스레드 환경에서 여러 스레드가 동시에 하나의 객체 및 변수(공유자원)에 접근할 때 의도한 대로 동작하는 것을 말함
- Thread-safe하게 구현하기 위해서는 공유 자원에 접근하는 임계 영역(critical section)을 동기화 기법으로 제어해줘야 함
    - 상호배제 (Mutex : Mutual eXclusion)
        - 하나의 프로세스만 임계구역을 사용할 수 있도록 다른 프로세스의 접근을 차단하는 것으로 상호배제 위한 4가지 요구조건이 충족되야함
            - 두 개 이상의 프로세스들이 동시에 임계구역에 있으면 안됨
            - 어떤 프로세스도 임계구역에 진입하는 것이 무한정 연기되면 안됨
            - 임계구역 안에 있는 프로세스가 다른 프로세스의 임계구역 진입을 막을 수 있어야 함
            - 프로세스들의 상대적인 속도(각 프로세스들의 처리 속도, 접근 방법, 상태)에 대해 어떠한 가정을 하면 안됨
        - 세마포어(Semaphore)
            - 임계구역을 지키기 위한 기존 상호배제 알고리즘이 바쁜 대기 현상을 야기하는 것을 방지하고자 개발된 알고리즘으로 프로세스가 바쁜 대기 현상을 방지하기 위해 잠시 재우고(Sleep, Wait, P연산) 나중에 깨워주는(Wakeup, Signal, V연산) 방식을 사용
            - 세마포어에 대한 연산은 소프트웨어 및 하드웨어로 구현되며 연산 처리 중에 인터럽트 되서는 안됨
            - 이진 세마포어는 0,1 값을 가지고 산술 세마포어는 0, 자연수를 가짐
            - 프로세스 사이의 동기를 유지하게 함 (동기화)
        - 모니터 (Monitor)
            - 세마포어 알고리즘을 구현한 프로그램
            - 모니터는 프로세스들이 사용할 수 있는 공유 자원 혹은 공유 자원 그룹을 할당하는데 사용함
            - 데이터 및 프로시저를 포함하는 병행성 구조(Concurrent Construct)
            - 모니터 외부의 프로세스는 모니터 내부의 데이터를 직접 접근할 수 없음
            - 캡슐화 개념을 사용하며 스위치 개념이 적용되어 한 번에 하나의 프로세스만 모니터에 진입(entry) 할 수 있음
        - [https://velog.io/@chaeshee0908/상호배제Mutex](https://velog.io/@chaeshee0908/%EC%83%81%ED%98%B8%EB%B0%B0%EC%A0%9CMutex)
- Reentrant
    - Reentrant는 재진입성 이라는 의미로 어떤 함수가 Reentrant하다는 것은 여러 스레드가 동시에 접근해도 언제나 같은 실행 결과를 보장한다는 의미
        - 이를 만족하기 위해선 해당 서브루틴에서는 공유자원을 사용하지 않으면 됨
    - Reentrant 하다면 Thread-safe 하지만 그 역은 성립하지 않음

### 동기화 객체 종류

- 스레드 동기화 방법
    1. 실행 순서의 동기화
        - 스레드의 실행순서를 정의하고, 이 순서에 반드시 따르도록 하는 것
    2. 메모리 접근에 대한 동기화
        - 메모리 접근에 있어서 동시접근을 막는 것
        - 실행의 순서가 중요한 상황이 아니고, 한 순간에 하나의 스레드만 접근하면 되는 상황을 의미
- 동기화 기법의 종류
    1. 유저 모드 동기화
        - 커널의 힘을 빌리지 않는(커널 코드가 실행되지 않는) 동기화 기법
        - 성능상 이점, 기능상의 제한
        - **Ex) 크리티컬 섹션 기반의 동기화, 인터락 함수 기반의 동기화**
    2. 커널 모드 동기화
        - 커널에서 제공하는 동기화 기능을 활용하는 방법
        - 커널 모드로의 변경이 필요하고 이는 성능 저하로 이어짐, 다양한 기능 활용 가능
        - **Ex) 뮤텍스 기반의 동기화, 세마포어 기반의 동기화, 이름있는 뮤텍스 기반의 프로세스 동기화, 이벤트 기반의 동기화**
